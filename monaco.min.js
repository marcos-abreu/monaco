!function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var o=this.Monaco=this.Monaco||{},i=o.Application=function(t,r){if(!t)throw new Error("Monaco :: missing required application parameter: appName");r=r||{},this.name=t,this.options=r,this.cid=e.uniqueId("app"),this._settings={},this.models={},this.collections={},this.views={};var i=r.RouterClass||o.Router;this.router=new i({app:this,routes:r.routes}),o.trigger("app:built",this,r)};e.extend(i.prototype,t.Events,{start:function(t){if(t=t||{},t.pushState=t.pushState||!1,!e.has(this,"router"))throw new Error("Monaco :: missing required router instance before starting the application");this.router._addRoutes(),o.history.start(t),o.trigger("app:initialized",this,t)},add:function(e,t){if(!t.prototype||!t.prototype.namespace)throw new Error("Monaco :: missing required object property 'namespace'");if(this[t.prototype.namespace][e])throw new Error("Monaco :: "+e+" have already been defined in "+this.name+"."+t.prototype.namespace);t.prototype._app=this,this[t.prototype.namespace][e]=t},get:function(t){if(e.has(this._settings,t))return this._settings[t];var o=null;try{o=JSON.parse(r.getItem(t))}catch(i){return void 0}return null===o?void 0:(this._settings[t]=o,o)},set:function(e,t,o){if(o=o||!1,void 0===e||void 0===t)throw new Error("set method required both key and value parameters { key: "+e+" | value: "+t+" }");if(this._settings[e]=t,o===!0)try{r.setItem(e,JSON.stringify(t))}catch(i){return!1}return!0}}),e.extend(o,t.Events);var n=function(e){e=e||{};var t=e.error,r=this._app&this._app.router?this._app.router:null;return e.error=function(e,o,i){r&&r.trigger("route:fetch.error",e,o,i),t&&t.apply(this,arguments)},e},s=function(e){return e=n.call(this,e),t.Collection.prototype.fetch.call(this,e)};try{o.Collection=t.Collection.extend({namespace:"collections",fetch:s})}catch(a){o.Collection=t.Collection,o.Collection.prototype.namespace="collections",o.Collection.prototype.fetch=s}var c=function(e){return e=n.call(this,e),t.Model.prototype.fetch.call(this,e)};try{o.Model=t.Model.extend({namespace:"models",fetch:c})}catch(a){o.Model=t.Model,o.Model.prototype.namespace="models",o.Model.prototype.fetch=c}return o.View=t.View.extend({namespace:"views"}),o.Router=t.Router.extend({_uroutes:[],_routes:[],constructor:function(r){this.app=arguments.length>0?arguments[0].app:void 0;var o=this.initialize;this.initialize=function(t){e.each(t.routes,function(e,t){this._routes.push({key:t,value:e})},this),o.apply(this,arguments)},t.Router.prototype.constructor.apply(this,arguments)},add:function(t){var r,o;if(!t||!e.isObject(t))throw new Error("invalid routes format - please check the docs");for(o=e.keys(t);r=o.pop();)this._uroutes.unshift({key:r,value:t[r]})},_getFuncName:function(e){var t;if("function"==typeof e)return e.name?e.name:(t=e.toString().match(/function ([^\(]+)/),t&&t[1]?t[1]:void 0)},_addRoutes:function(){for(var e;e=this._uroutes.pop();)this._routes.push(e),this._addRoute(e.key,e.value)},_addRoute:function(t,r){var o,i;if(r=r||{},""!==t&&!t)throw new Error("invalid route: "+t);if(e.isString(r))o=r;else{if(!(e.isArray(r)&&r.length>0))throw new Error("monaco :: invalid route options from route: "+t);o=r[0],"function"==typeof o?(i=o,o=this._getFuncName(i)||""):"function"==typeof r[1]&&(i=r[1])}if(!o||!e.isString(o)||""===o&&!i)throw new Error("invalid callback (name) from route: "+t);return this.route(t,o,i)}}),o.History=t.History,o.history=t.history,o}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var o=this.Monaco=this.Monaco||{},i=/\((.*?)\)/g,n=/(\(\?)?:\w+/g,s=/\*\w+/g,a=/[\-{}\[\]+?.,\\\^$|#\s]/g;return o.Router.prototype._routeConstraints=function(t){var r=e.find(this._routes,function(e){return e.key===t});return r&&r.value&&e.isArray(r.value)&&r.value.length>1&&e.isObject(r.value[1])?r.value[1].regexp:void 0},o.Router.prototype._routeToRegExp=function(e){var t=this._routeConstraints(e);return e=e.replace(a,"\\$&").replace(i,"(?:$1)?").replace(n,function(e,r){if(t&&t[e.substr(1)]){var o=t[e.substr(1)].toString();return"("+o.slice(1,o.lastIndexOf("/"))+")"}return r?e:"([^/]+)"}).replace(s,"(.*?)"),new RegExp("^"+e+"$")},o.Router.prototype.filter=function(e,t){for(var r,o=e.length-1,i=0;o>=i;o--)r=t,t=this._wrapFilter(e[o],r);return t},o.Router.prototype._filters={},o.Router.prototype._wrapFilter=function(t,r){return e.bind(function(){this._filters[t].call(this,r,arguments)},this)},o.Router.prototype.addFilter=function(e,t){if(this._filters[e])throw new Error("Monaco :: filter already exists: "+e);this._filters[e]=t},o.Router.prototype._getByName=function(t){var r=e.map(this._routes,function(r,o){return e.isArray(r)&&r.length>1&&(e.isString(r[1])&&r[1]===t||e.isObject(r[1])&&r.name===t)?o:null}),o=e.compact(r);return o.length>0?o[0]:!1},o.Router.prototype.reverse=function(t,r){var o="";if(r=r||{},!t)throw new Error("Monaco :: required `name` parameter for `reverse` method");return o=this._getByName(t),e.each(r,function(e,t){o=o.replace(":"+t,e)}),o},o}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var o=this.Monaco=this.Monaco||{},i=[],n=i.slice,s=o.ViewManager=function(e,t){this.options=t||{},this._children={},e&&e instanceof o.View&&(this.listenTo(e,"rendered",this._onParentRender),this.listenTo(e,"beforeRemove",this._onParentRemove))};s.prototype=e.extend(s.prototype,{_onParentRender:function(e){this.options.autoRender!==!1&&this.each(function(t,r){var o=e.$el.find(r);o.length>0&&o.html(t.render().$el)},this)},_onParentRemove:function(){this.invoke("remove")},_onChildRemove:function(e){var t=this.find(this._children,{cid:e.cid});t&&(this._children[t]=void 0)},_addChild:function(e,t){return this._children[e]&&this._children[e].remove(),this._children[e]=t,this.listenTo(this._children[e],"remove",this._onChildRemove),this._children[e]},add:function(t,r){var i={};if("string"==typeof t&&""!==t&&r instanceof o.View)i[t]=r;else{if("object"!=typeof t)throw new Error("Monaco.ViewManager :: invalid parameters when setting subviews");i=t,r=t}return e.each(i,function(e,t){"string"==typeof t&&""!==t&&e instanceof o.View&&this._addChild(t,e)},this),r},set:function(){return this.add.apply(this,arguments)},get:function(e){return this._children[e]}});var a=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","shuffle","isEmpty","chain","sample","partition"];e.each(a,function(t){e[t]&&(s.prototype[t]=function(){var r=n.call(arguments);return r.unshift(this._children),e[t].apply(e,r)})});var c=o.View;return o.View=c.extend({constructor:function(t){t=t||{},c.prototype.constructor.apply(this,arguments),this.subviews=new o.ViewManager(this,t);var r=this.render;this.render=e.bind(function(){var e;return e=r.apply(this,arguments),Promise&&e instanceof Promise?e.then(function(e){e.trigger("rendered",e)}):(this.trigger("rendered",this),e)},this);var i=this.remove;this.remove=e.bind(function(){var e;return this.trigger("beforeRemove",this),e=i.apply(this,arguments),Promise&&e instanceof Promise?e.then(function(e){e.trigger("rendered",e)}):(this.trigger("removed",this),e)},this)}}),o}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var o=this.Monaco=this.Monaco||{};o.on("app:built",function(t,r){if(t.local._app=t,e.has(r,"cacheLocal")&&(t.local.autoCache=Boolean(e.result(r,"cacheLocal"))),e.has(r,"cacheExpire")){var o=e.result(r,"cacheExpire");t.local.cacheExpire=e.isNull(o)||e.isNumber(o)?o:void 0}r.prefetched&&(e.each(r.prefetched,function(e,t){e.data&&this.local.set({resource:t,models:[]},e.data,e.expire)},t),delete t.options.prefetched)});var i=o.Application.prototype.add;o.Application.prototype.add=function(e,t){if("collections"===t.prototype.namespace&&(!t.prototype.resource||""===t.prototype.resource))throw new Error("Monaco :: required `resource` property missing from this collection definition");return i.apply(this,arguments)},o.Application.prototype.local={autoCache:!1,cacheExpire:30,get:function(t){var r=e.has(t,"models"),o=r?t:t.collection||null,i=o?e.result(o,"resource"):e.result(t,"resource");if(i){var n=this._getLocalData(i);if(n){if(n.resp=this.decompress(n.resp),r)return n.resp;if(o){if(n=e.find(o.parse(n.resp),function(e){return e[t.idAttribute]===t.id}),n&&(!n._ts||!this._isExpired(n)))return delete n._ts,n}else if(n.resp[t.idAttribute]===t.id)return n.resp}}return void 0},set:function(t,r,o){var i=e.has(t,"models"),n=i?t:t.collection||null,s=n?e.result(n,"resource"):e.result(t,"resource");if(o=void 0!==o?o:!1,s){if(!i&&n){var a=o||e.result(t,"expireLocal");a&&(r=this._setExpire(r,a,!0)),r=this._addToCollectionData(t,r,n),o=o!==!1?o:e.result(n,"expireLocal")}else o=o!==!1?o:e.result(t,"expireLocal");return r=this.compress(r),r=this._setExpire(r,o),this._storageSet(s,r),this._memorySet(s,r),!0}},clear:function(e){return e=e||null,e?this._clearItem(e):this._clearAll()},compress:function(e){return e},decompress:function(e){return e},_getLocalData:function(t){for(var r=null,o=["memory","storage"],i=0,n=o.length;n>i;i++){if(r=this["_"+o[i]+"Get"](t),r&&!this._isExpired(r))return"storage"===o[i]&&this._memorySet(t,r),e.clone(r);r&&this.clear(t)}return null},_addToCollectionData:function(e,t,r){var o=r.get(e.id);return o?o.set(t,{silent:!0}):r.add(t,{silent:!0}),r.revertParse&&"function"==typeof r.revertParse?r.revertParse():r.toJSON()},_memoryGet:function(e){return this._memory?this._memory[e]:null},_memorySet:function(e,t){this._memory=this._memory||{},this._memory[e]=t},_storageGet:function(e){var t;try{t=r.getItem(this._getKey(e))}catch(o){return null}return void 0===t||"undefined"===t||null===t?null:JSON.parse(t)},_storageSet:function(e,t){var o,i=this._getKey(e);try{o=r.getItem("monaco-"+this._app.name+":keys")||"{}"}catch(n){return}var s=JSON.parse(o);s[i]=t._ts;try{r.setItem("monaco-"+this._app.name+":keys",JSON.stringify(s)),r.setItem(i,JSON.stringify(t))}catch(n){try{r.setItem("monaco-"+this._app.name+":keys",o)}catch(a){}}},_setExpire:function(t,r,o){var i=null;if(r=e.isNumber(r)||e.isNull(r)?r:void 0,!e.isNull(r)){var n=new Date;n.setMinutes(n.getMinutes()+(r||this.cacheExpire)),i=n.getTime()}return o===!0?(t._ts=i,t):{_ts:i,resp:t}},_isExpired:function(t){var r=t._ts,o=new Date;return!e.isNull(r)&&o.getTime()>r},_clearItem:function(t){var o=this._getKey(t);try{r.removeItem(o)}catch(i){throw new Error("Monaco :: unable to remove the localStorage key: "+o)}e.has(this._memory,t)&&delete this._memory[t];var n;try{n=JSON.parse(r.getItem("monaco-"+this._app.name+":keys"))||{}}catch(i){}return n?(delete n[o],this._app.set("monaco-"+this._app.name+":keys",n,!0)):void 0},_clearAll:function(){var t={};try{t=JSON.parse(r.getItem("monaco-"+this._app.name+":keys"))||{}}catch(o){}e.each(t,function(e,t){try{var o=t.split("#");o=o[1],r.removeItem(t)}catch(i){}},this),this._memory={},this._app.set("monaco-"+this._app.name+":keys",{},!0)},_getKey:function(e){return this._app.name+"#"+e}};var n=o.Collection.prototype.initialize;o.Collection.prototype.initialize=function(){return this._cacheCollection=function(t){var r;!this._app||t.fromLocal||e.result(this,"cacheLocal")!==!0&&this._app.local.autoCache!==!0||(r=this.revertParse&&"function"==typeof this.revertParse?this.revertParse():this.toJSON(),this._app.local.set(this,r))},this.on("reset",function(){var t=arguments.length>0?arguments[arguments.length-1]:{},r=e.resolve(this,r);r&&this.length>0?this._cacheCollection(t):r&&this._app.clear(r)}),this.on("add remove change",function(){var e=arguments.length>0?arguments[arguments.length-1]:{};this._cacheCollection(e)},this),n.apply(this,arguments)};var s=o.Model.prototype.initialize;return o.Model.prototype.initialize=function(){return this._cacheModel=function(t){var r;!this._app||t.fromLocal||e.result(this,"cacheLocal")!==!0&&this._app.local.autoCache!==!0||(r=this.revertParse&&"function"==typeof this.revertParse?this.revertParse():this.toJSON(),this._app.local.set(this,r))},this.on("change",function(){var e=arguments.length>0?arguments[arguments.length-1]:{};this._cacheModel(e)},this),s.apply(this,arguments)},o.sync=t.sync,t.sync=function(t,r,i){i=i||{};var n=r._app,s=i.localOnly===!0||r.localOnly===!0;if(n&&"read"===t){var a=i.fresh===!0?null:n.local.get(r);if(a)return i.fromLocal=!0,i.success&&i.success(a),!0;var c=e.has(r,"models");if(s===!0)return void(i.error&&i.error({},"Error: resource not found locally",{}));var u,h=!1,l=c&&r.cachePolicy?r.cachePolicy:!c&&r.collection?r.collection.cachePolicy:n.options.cachePolicy?n.options.cachePolicy:void 0;h=l&&"local"!==l,(e.result(i,"cacheLocal")===!0||!e.has(i,"cacheLocal")&&c&&e.result(r,"cacheLocal")===!0||!e.has(i,"cacheLocal")&&!c&&r.collection&&e.result(r.collection,"cacheLocal")===!0||!e.has(i,"cacheLocal")&&!c&&!r.collection&&e.result(r,"cacheLocal")===!0||!e.has(i,"cacheLocal")&&!e.has(r,"cacheLocal")&&n.local.autoCache===!0)&&(h=!0),h&&(u=i.success,i.success=function(t,o,s){if(l&&"local"!==l){var a=s.getResponseHeader(l);a&&(a=parseInt(a.match(/max-age=([\d]+)/)[1],10),a&&a/60>0&&n.local.set(r,t,a/60))}else n.local.set(r,t,e.result(i,"expireLocal"));u&&u.apply(this,arguments)})}if(s!==!0)return o.sync(t,r,i)},o}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var o=this.Monaco=this.Monaco||{},i=this.Monaco.History.prototype.loadUrl,n=this;return o.History.prototype.loadUrl=function(){var e=i.apply(this,arguments),t=this.fragment;return/^\//.test(t)||(t="/"+t),this.trackPageview(t),e},o.History.prototype.trackPageview=function(e){void 0!==n.ga&&n.ga("send","pageview",e)},o}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var o=this.Monaco=this.Monaco||{};o.on("app:built",function(e,t){e.experiments=new o.Experiments(t.experiments)});var i=o.Experiments=function(t){t=t||{},this._experiments=[],this.options=e.extend({ga:{slot:1,scope:2},cookie:{prefix:"ab-",days:360,baseDomain:!1}},t)};i.prototype=e.extend(i.prototype,{get:function(t){return e.find(this._experiments,function(e){return e.key===t})},set:function(t,r,i){var n=t;n instanceof o.Experiment||(n=new o.Experiment(this,t,r,e.extend({},this.options,i))),this._experiments.push(n)},optout:function(){e.each(this._experiments,function(e){e.optout()})},split:function(){e.each(this._experiments,function(e,t){e.split()})}});var n=o.Experiment=function(t,r,i,n){if(!r)throw new Error("Monaco :: failed to create the experiment: "+r+" - experiment key required");if(i=i||{},n=n||{},n.users=n.users||0,!e.isNumber(n.users)||n.users>1||n.users<0)throw new Error("Monaco :: failed processing experiment: '"+r+"' - users not defined within allowed range");if(this.usersPerGroup=Math.floor(100*n.users/e.size(i)),this.usersPerGroup<1)throw new Error("Monaco :: failed processing experiment: '"+r+"' - individual groups set to less than 1%");this.parent=t,this.key=r,this.groups=i,this.normalized=this._normalizeGroup(i),this.options=n,this.cookie={set:o.utils.setCookie,get:o.utils.getCookie}};return n.prototype=e.extend(n.prototype,{original:"__original__",current:null,split:function(){if(!this.current){var e=this.options.cookie,t=this.cookie.get(e.prefix+this.key);t||(t=this.normalized[Math.floor(Math.random()*this.normalized.length)],this.cookie.set(e.prefix+this.key,t,e.days,e.baseDomain),this.saveGroup(t)),this.current=t}return this.current},get:function(e){return!e&&this.current?this.groups[this.current]:e?this.groups[e]:void 0},controller:function(e){return this.current&&this.current!==this.original?e+this.get(this.current).suffix:e},view:function(e){return this.current&&this.current!==this.original?e+this.get(this.current).suffix:e},template:function(e){return this.current&&this.current!==this.original?e+"."+this.get(this.current).suffix:e},optout:function(){var e=this.options.cookie;this.cookie.set(e.prefix+this.key,this.original,e.days,e.baseDomain)},saveGroup:function(e){_gaq.push(["_setCustomVar",this.options.ga.slot,this.key,e,this.options.ga.scope]),_gaq.push(["_trackEvent","experiments","join",this.key+"|"+e])},toJSON:function(){return{current:this.current,group:this.get(),groups:this.groups}},_normalizeGroup:function(e){var t=[],r=0;for(var o in e)if(e.hasOwnProperty(o))for(var i=0,n=this.usersPerGroup;n>i;i++)t.push(o),r++;for(var s=100-r;--s>=0;)t.push(this.original);return t}}),o}),function(e,t){"function"==typeof define&&define.amd?define(["lodash","backbone","storage"],t):"object"==typeof exports?module.exports=t(require("lodash"),require("backbone"),require("storage")):e.Monaco=t(e._,e.Backbone,e.localStorage)}(this,function(e,t,r){var o=this.Monaco=this.Monaco||{},i=o.utils=o.utils||{};o.on("app:built",function(e,t){e.transitions={}}),o.Application.prototype.transitionTo=function(e,t,r){if(!e)throw new Error("Monaco :: missing target view");var i=this.currentView||null,n=r||this.transitions.DefaultTransition||o.Transition,s=new n;this.currentView=s.start(i,e,t)};var n=o.Transition=function(e){this.initialize.apply(this,arguments)};return e.extend(o.Transition.prototype,t.Events,{namespace:"transitions",initialize:function(){},start:function(e,t,r){return r=r||{},e&&t.el===e.el?(e.remove(),t.render(r)):e?(t.render(r),e.remove()):t.render(r),t}}),n.extend=i.extend,o});
//# sourceMappingURL=monaco.min.js.map